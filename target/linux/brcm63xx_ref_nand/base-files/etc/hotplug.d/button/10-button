#!/bin/sh

. /lib/functions.sh
. /usr/share/libubox/jshn.sh

wpsbutton_action () {
        killall -USR2 wps_monitor
}

case "$ACTION" in
        add|register)
        [ "resetbutton" == "$INTERFACE" ] && {
                ubus call leds set '{ "state": "test"}'
                printf "\n\n*** Restore to default settings ***\n\n" > /dev/console
		rm -rf /rom/overlay/*
		rm -rf /rom/etc/adsl/adsl_phy.bin
		export REBOOT_REASON=defaultreset
		reboot
        }
        [ "ecobutton" == "$INTERFACE" ] && {
		if ! pidof ecobutton; then
			/sbin/ecobutton &
		fi
		local buttoncomb=""
		[ -f "/var/buttoncomb" ] && buttoncomb="$(cat /var/buttoncomb)"
		echo  $buttoncomb"eco" > /var/buttoncomb
        }
        [ "wpsbutton" == "$INTERFACE" ] && {
	        printf "\n\nWPS button is pressed\n\n" > /dev/console
		wpsbutton_action
        }
        [ "dectshort" == "$INTERFACE" ] && {
		/usr/bin/dect -b 1 | logger -t hotplug -p user.info
        }
        [ "dectlong" == "$INTERFACE" ] && {
		case $(uci get dect.dect.radio) in
			auto|off)
				uci set dect.dect.radio=on
				;;
			on)
				uci set dect.dect.radio=off
				;;
		esac
		/usr/bin/dect -c | logger -t hotplug -p user.info
		/usr/bin/dect -b 2 | logger -t hotplug -p user.info
        }
        [ "infobutton" == "$INTERFACE" ] && {
                printf "\n\nINFO button is pressed\n\n" > /dev/console
                local parsed=$(ubus call leds status)
                json_load "$parsed"
                json_get_var ledstate state

                [ "$ledstate" == "normal" ] && {
                        ubus call leds set '{ "state": "info"}'
                        ubus call led.eco set '{ "state": "notice"}'
                } || {
                        ubus call leds set '{ "state": "normal"}'
                        ubus call led.eco set '{ "state": "off"}'
                }
        }
	[ "communicationbutton" == "$INTERFACE" ] && {
		printf "\n\nCommunication button pressed - not implemented!\n\n" > /dev/console
	}
	[ "servicebutton" == "$INTERFACE" ] && {
		printf "\n\nService button pressed - not implemented!\n\n" > /dev/console
	}
	[ "pairbutton" == "$INTERFACE" ] && {
		printf "\n\nPair button pressed\n\n" > /dev/console
		wpsbutton_action
		/usr/bin/dect -b 1 | logger -t hotplug -p user.info
	}
	[ "cancelbutton" == "$INTERFACE" ] && {
		printf "\n\nCancel button pressed - not implemented!\n\n" > /dev/console
	}
	[ "touch_near" == "$INTERFACE" ] && {
	        ubus call leds proximity '{ "timeout" : "15", "light-all" : "2" }'
	}
	[ "touch_far" == "$INTERFACE" ] && {
	        ubus call leds proximity '{ "timeout" : "300" }'
	}
        ;;
        remove|unregister)
        ;;
esac
